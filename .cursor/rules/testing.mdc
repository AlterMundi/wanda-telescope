# Testing & Quality Assurance Rules

## Test Organization
```
tests/
├── conftest.py          # Shared fixtures
├── unit/               # No hardware dependencies
├── integration/        # Component interactions
├── web/               # API endpoint tests
└── performance/        # Benchmark tests
```

## Quick Test Commands

### Unit Testing
```bash
pytest tests/unit/ -q --tb=short           # Quick unit test run
pytest tests/unit/ --maxfail=1             # Stop on first failure
pytest -m "not slow" tests/                # Skip slow tests
```

### Integration Testing
```bash
pytest tests/integration/ -v               # Verbose integration tests
pytest tests/integration/test_camera_mount_integration.py
```

### Coverage Testing
```bash
pytest --cov=camera,mount,web,utils,session --cov-report=term-missing
pytest --cov-fail-under=85                 # Fail if below 85%
pytest --cov-report=html                   # Generate HTML report
```

## Performance Requirements
- Camera capture: < 100ms for frame acquisition
- Still capture: < 500ms at full resolution
- Mount tracking: < 10ms stepper response
- Web API: < 200ms endpoint response
- MJPEG stream: < 200ms latency

## Test Implementation Patterns

### Fixture Usage
```python
@pytest.fixture
def mock_camera():
    """Provide configured mock camera."""
    from camera.implementations.mock_camera import MockCamera
    camera = MockCamera()
    camera.initialize()
    yield camera
    camera.cleanup()
```

### Hardware Mocking
```python
@patch('RPi.GPIO')
@patch('picamera2.Picamera2')
def test_with_mocked_hardware(mock_picamera, mock_gpio):
    """Test with hardware dependencies mocked."""
    pass
```

### Error Testing
```python
def test_camera_handles_timeout():
    """Verify timeout handling."""
    with pytest.raises(CameraTimeoutError):
        camera.capture_image(timeout=0.001)
```

## Pre-Commit Checklist
- [ ] All tests pass locally
- [ ] Coverage >= 85%
- [ ] No hardcoded test data paths
- [ ] Mocks properly cleaned up
- [ ] Performance benchmarks pass
- [ ] Integration tests verified